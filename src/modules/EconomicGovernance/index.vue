<template>
  <wrap-title class="gradient-bg" icon="icon-jingji" txt="经济治理">
    <p class="shopText" @click="openNewTab">”五.五购物节”</p>
    <level-title :level="2" icon="icon-biaoti" txt="重点产业和房地产税收收入"></level-title>
    <overview-item
      style="margin-top: -0.2rem;"
      valueUnit="亿元"
      :value="dataset.statistics.six_industries_tax_revenue"
      :increase="dataset.statistics.six_industries_tax_revenue_increase"
      customClass="style7"></overview-item>
    <chart-pie class="in-flex" :chartData="dataset.ldcysssr_db" :colors="colors" :fontSize="0.24" unit="亿元" labelColor="#D1C9C4">
      <template v-slot:li="{ item }">
        <span class="legend-label text-ellipsis">{{ item[0] }}</span>
        <span class="legend-percent">{{ item[3] }}%</span>
      </template>
    </chart-pie>
    <level-title :level="2" icon="icon-biaoti">
      <m-tabs class="levelt2-select" ref="jingji" v-model="tab" :tabs="tabs"></m-tabs>
    </level-title>
    <overview-item
       @mouseenter.native="handleMouse('jingji', 'enter')" @mouseleave.native="handleMouse('jingji', 'leave')"
      style="margin-top: -0.2rem;"
      valueBefore="税收收入"
      valueUnit="亿元"
      :showIncrease="false"
      :value="dataset.statistics[tab]"
      :increase="dataset.statistics[tab + '_increase']"
      customClass="style7">
    </overview-item>
    <m-tabs-body class="in-flex" :tab="tab">
      <m-tabs-body-item name="yzsd" lazy>
        <chart-pie :chartData="dataset.yzsd_db" :colors="colors" :fontSize="0.24" unit="亿元" labelColor="#D1C9C4">
          <template v-slot:li="{ item }">
            <span class="legend-label" :class="{clickAble: item[0] ==='南京西路'}" style="word-break:break-all;white-space:normal;"  @click="handleClickYZSD(item)">{{ item[0] }}</span>
            <span class="legend-percent">{{ item[3] }}%</span>
          </template>
        </chart-pie>
      </m-tabs-body-item>
      <m-tabs-body-item name="lyjj" lazy>
        <chart-bary :chartData="dataset.lyjj_db" labelColor="#fff" :colors="colors2" :isGradient="true"></chart-bary>
      </m-tabs-body-item>
      <m-tabs-body-item name="zbjj" lazy>
        <chart-pie :chartData="dataset.zbjj_db" :colors="colors" :fontSize="0.24" unit="亿元" labelColor="#D1C9C4">
          <template v-slot:li="{ item }">
            <span class="legend-label text-ellipsis">{{ item[0] }}</span>
            <span class="legend-percent">{{ item[3] }}%</span>
          </template>
        </chart-pie>
      </m-tabs-body-item>
      <m-tabs-body-item name="yqjj" lazy>
        <chart-bary :chartData="dataset.yqjj_db" labelColor="#fff" :colors="colors2" :isGradient="true"></chart-bary>
      </m-tabs-body-item>
    </m-tabs-body>
    <level-title :level="2" icon="icon-biaoti">
      <m-tabs class="levelt2-select" ref="shehui" v-model="tab2" :tabs="tabs2"></m-tabs>
    </level-title>
    <m-tabs-body class="autoHeight" :tab="tab2">
      <m-tabs-body-item name="社会消费" lazy @mouseenter.native="handleMouse('shehui', 'enter')" @mouseleave.native="handleMouse('shehui', 'leave')"
>
        <m-row>
          <m-column>
            <overview-item
              name="商品销售总额"
              :value="dataset.statistics.goods_total_sales"
              :increase="dataset.statistics.goods_total_sales_increase"
              valueUnit="亿元"
              customClass="style7">
            </overview-item>
          </m-column>
          <m-column>
            <overview-item
              name="主要商业综合体"
              :value="dataset.statistics.major_commercial_complex"
              :increase="dataset.statistics.major_commercial_complex_increase"
              valueUnit="亿元"
              customClass="style7">
            </overview-item>
          </m-column>
          <m-column>
            <overview-item
              name="旅行社接待"
              :value="dataset.statistics.tourism_reception"
              :increase="dataset.statistics.tourism_reception_increase"
              valueUnit="人次"
              customClass="style7">
            </overview-item>
          </m-column>
        </m-row>
      </m-tabs-body-item>
      <m-tabs-body-item name="外商投资" lazy @mouseenter.native="handleMouse('shehui', 'enter')" @mouseleave.native="handleMouse('shehui', 'leave')">
        <m-row>
          <m-column>
            <overview-item
              name="合同项目"
              :value="dataset.statistics.contract_items"
              :increase="dataset.statistics.contract_items_increase"
              valueUnit="个"
              customClass="style7">
            </overview-item>
          </m-column>
          <m-column>
            <overview-item
              name="合同金额"
              :value="dataset.statistics.contract_amount"
              :increase="dataset.statistics.contract_amount_increase"
              valueUnit="万美元"
              customClass="style7">
            </overview-item>
          </m-column>
        </m-row>
      </m-tabs-body-item>
      <m-tabs-body-item name="招商引资" lazy @mouseenter.native="handleMouse('shehui', 'enter')" @mouseleave.native="handleMouse('shehui', 'leave')">
        <m-row>
          <m-column>
            <overview-item
              name="新增企业（家）"
              :value="dataset.statistics.new_enterprises_number"
              :increase="dataset.statistics.new_enterprises_number_increase"
              customClass="style7">
            </overview-item>
          </m-column>
          <m-column>
            <overview-item
              name="外资企业占比"
              :value="dataset.statistics.foreign_funded_enterprises_percent"
              :increase="dataset.statistics.foreign_funded_enterprises_percent_increase"
              valueUnit="%"
              customClass="style7">
            </overview-item>
          </m-column>
          <m-column>
            <overview-item
              name="千万级投资占比"
              :value="dataset.statistics.ten_million_investment_percent"
              :increase="dataset.statistics.ten_million_investment_percent_increase"
              valueUnit="%"
              customClass="style7">
            </overview-item>
          </m-column>
        </m-row>
      </m-tabs-body-item>
      <m-tabs-body-item name="科技创新" lazy @mouseenter.native="handleMouse('shehui', 'enter')" @mouseleave.native="handleMouse('shehui', 'leave')">
        <m-row>
          <m-column>
            <overview-item
              name="专利授权数（件）"
              :value="dataset.statistics.patents_granted_number"
              :increase="dataset.statistics.patents_granted_number_increase"
              customClass="style7">
            </overview-item>
          </m-column>
          <m-column>
            <overview-item
              name="技术合同项目（项）"
              :value="dataset.statistics.technical_contract_project"
              :increase="dataset.statistics.technical_contract_project_increase"
              customClass="style7">
            </overview-item>
          </m-column>
        </m-row>
      </m-tabs-body-item>
    </m-tabs-body>
    <MDialog :dialogVisible.sync="dialogShow" appendDom=".layout" :extraCss="extraCss">
      <video v-if="dialogShow" :src=" prefix + '/videos/nx.mp4'" style="width:100%;height: 100%;object-fit:cover;" autoplay loop ></video>
    </MDialog>
  </wrap-title>
</template>
<script>
import MDialog from "@/components/MDialog/index";
import WrapTitle from "@/components/MTitle/WrapTitle";
import LevelTitle from "@/components/MTitle/LevelTitle";
import MSelect from "@/components/MSelect";
import OverviewItem from "@/components/OverviewItem";
import MTabs from "@/components/MTabs";
import MTabsBody from "@/components/MTabsBody/MTabsBody";
import MTabsBodyItem from "@/components/MTabsBody/MTabsBodyItem";
import Increase from "@/components/Increase";
import MRow from "@/components/Layout/MRow";
import MColumn from "@/components/Layout/MColumn";
import ChartPie from "./components/ChartPie";
import ChartBary from "@/components/Charts/BarY/ChartBarYForValuePosition";
import { getData } from "./api";
export default {
  name: "EconomicGovernance",
  components: {
    MDialog,
    WrapTitle,
    LevelTitle,
    MSelect,
    OverviewItem,
    MTabs,
    MTabsBody,
    MTabsBodyItem,
    Increase,
    MRow,
    MColumn,
    ChartPie,
    ChartBary
  },
  inject: ["createFnForCalcRealPx"],
  data() {
    const arr = window.location.href.split("/");
    arr.pop();
    const prefix = arr.join("/");
    return {
      extraCss: {
        // top: "1.5rem"
        width: "100%"
      },
      prefix: prefix,
      urls: [
        {
          url: prefix + "/videos/nx.mp4"
        }
      ],
      dialogShow: false,
      colors: Object.freeze(["#30BC9B", "#2E9BCF", "#4FCFD5", "#4E78A4", "#1D7774", "#D1C9C4"]),
      colors2: Object.freeze(["#4FCFD5", "#2E9BCF"]),
      options: Object.freeze([
        { label: "本周", value: "currentWeek" },
        { label: "本月", value: "currentMonth" }
      ]),
      tabs: Object.freeze([
        { label: "一轴三带", value: "yzsd" },
        { label: "楼宇经济", value: "lyjj" },
        { label: "工业总产值", value: "zbjj" },
        { label: "四大功能区", value: "yqjj" }
      ]),
      tabs2: Object.freeze([
        { label: "社会消费", value: "社会消费" },
        { label: "外商投资", value: "外商投资" },
        { label: "招商引资", value: "招商引资" },
        { label: "科技创新", value: "科技创新" }
      ]),
      option: "currentWeek",
      tab: "yzsd",
      tab2: "社会消费",
      dataset: {
        statistics: {},
        ldcysssr_db: [
          ["五大产业和房地产业", "五大产业和房地产业"]
        ],
        yzsd_db: [
          ["一轴三带", "一轴三带"]
        ],
        lyjj_db: [
          ["楼宇经济", "楼宇经济"]
        ],
        zbjj_db: [
          ["总部经济", "总部经济"]
        ],
        yqjj_db: [
          ["园区经济", "园区经济"]
        ]
      }
    };
  },
  methods: {
    openNewTab() {
      this.$bus.$emit('showShopFestival')
    },
    handleMouse(ref, mouse) {
      if (mouse === "enter") {
        this.$refs[ref].stopTimer();
      } else {
        this.$refs[ref].startTimer();
      }
    },
    getData() {
      getData().then(res => {
        Object.keys(res).forEach(key => {
          let regForDB = /\w+_db$/g;
          if (regForDB.test(key)) {
            let dims = this.dataset[key].slice(0, 1);
            this.dataset[key] = Object.freeze([
              ...dims,
              ...((res[key] || []).map(d => {
                return [d.name, parseFloat(d.value), d.increase || "-", !d.percent || d.percent === "-" ? "-" : Math.round(d.percent * 10000) / 100];
              }))
            ]);
          }
        });
        if (res.statistics && res.statistics[0]) {
          this.dataset.statistics = res.statistics[0];
        }
        console.log(this.dataset, "-");
      });
    },
    handleClickYZSD(item) {
      console.log("<<>>>>>>>", item);
      if (item[0] === "南京西路") {
        this.dialogShow = true;
      }
    }
  },
  created() {
    this.$timer.register(this.getData, this);
  }
};
</script>
<style lang="scss" scoped>
.shopText {
  position: absolute;
  top: 0.3rem;
  right: 0.2rem;
  font-size: 0.4rem;
  font-weight: bold;
  color: #4FCFD5;
  cursor: pointer;
}
.clickAble{
  cursor: pointer;
}
.levelt2-select {
  &.m-tabs {
    color: #4E78A4;
  }
}
.autoHeight {
  &.m-tabs-body {
    height: auto;
  }
}
.zsyz {
  line-height: 1.5;
  .label {
    font-size: 0.28rem;
    color: $titleLevel2;
  }
  .value {
    font-size: 0.52rem;
    color: #4FCFD5;
    sub {
      font-size: 0.28rem;
      color:#4FCFD5;
      bottom: 0;
    }
  }
  .increase-wp {
    height: 0.36rem;
    display: flex;
    align-items: center;
  }
}
.legend-label {
  width: 0;
  flex: 1;
}
.legend-percent {
  width: 0.9rem;
  text-align: right;
  color: #fff;
}
</style>
