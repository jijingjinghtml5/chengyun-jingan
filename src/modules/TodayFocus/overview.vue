<template>
  <div class="overview">
    <div class="three-public">
        <div class="wall">
          <m-row gutter="10px">
            <m-column v-for="(item, index) in pubilcItems" :key="`public-${index}`">
              <tile :item="item" class="block"  ></tile>
            </m-column>
          </m-row>
        </div>
        <div class="chart">
          <wrap-title :level="2" txt="案件趋势" icon="icon-biaoti">
            <line-chart :showLegend="true" :legendConfig="legendConfig" :chartData="chartData" :colors="colors" :showYLabel="true" :pageLen="24" :isGradient="true" :gradientBySelf="true">
            </line-chart>
          </wrap-title>
        </div>
      </div>
      <div class="wall-panel">
        <m-row class="tile-row" gutter="20px" v-for="(chunk , i) in otherItems" :key="`other-chunk-${i}`">
            <MColumn span="5" v-for="(item, index) in chunk" :key="`other-${index}`">
              <tile1 :item="item" class="block clickAble" @click="handleClick(item)"></tile1>
            </MColumn>
          </m-row>
      </div>
  </div>
</template>
<script>
import WrapTitle from "@/components/MTitle/WrapTitle";
import MRow from "@/components/Layout/MRow";
import MColumn from "@/components/Layout/MColumn";
import LineChart from "@/components/Charts/Line/ChartLine";
import Tile from "@/components/Tile/index2";
import Tile1 from "@/components/Tile/index1";

import { getDate, generateKeyValuePair } from "@/utils/tools";

import Vue from "vue";
import { Row, Col } from "element-ui";
Vue.use(Row);
Vue.use(Col);

export default {
  name: "TodayFocusOverview",
  components: { WrapTitle, MRow, MColumn, LineChart, Tile, Tile1 },
  props: {
    dataset: {
      type: Object,
      default() {
        return {
          trendData: [],
          stats: {},
          gridData: {
            today: "-",
            yesterday: "-"
          },
          itemsData: {}
        };
      }
    }
  },
  computed: {
    otherItems() {
      let items = [...this.items].map(item => {
        return {
          ...item,
          ...(this.dataset.stats[item.key] || this.dataset.itemsData[item.key] || {})
        };
      });
      console.log("xxxxx", this.dataset.itemsData, items);
      const length = items.length;
      if (length < this.chunkSize) {
        return items;
      }
      let chunks = [];
      for (let i = 0; i < length; i += this.chunkSize) {
        chunks.push(items.splice(0, this.chunkSize));
      }
      return chunks;
    },
    pubilcItems() {
      const grid = this.dataset.gridData;
      let gridRate = grid.yesterday ? Math.floor(((grid.today - grid.yesterday) / grid.yesterday) * 10000) / 100 : "-";

      return [
        {
          label: "一网统管",
          count: grid.today,
          rate: gridRate,
          color: gridRate > 0 ? "#4FCFD5" : (gridRate < 0 ? "#E64C3B" : "#2E9BCF")
        },
        {
          icon: "icon-biaoti",
          label: "一网通办",
          count: this.dataset.itemsData["一网通办"] ? this.dataset.itemsData["一网通办"].value : "-",
          rate: this.dataset.itemsData["一网通办"] ? this.dataset.itemsData["一网通办"].rate : "-",
          color: "#2E9BCF"
        }
      ];
    },
    chartData() {
      const grid = generateKeyValuePair("time_fm", "count", this.dataset.trendData["网格"]);
      const zhongzhi = generateKeyValuePair("time_fm", "count", this.dataset.trendData["综治"]);
      const shichang = generateKeyValuePair("time_fm", "count", this.dataset.trendData["市场监管"]);
      const feijingqing = generateKeyValuePair("time_fm", "count", this.dataset.trendData["110非警情"]);

      return [
        ["时间", "网格", "综治", "市场监管", "110非警情"],
        ...getDate(7, { dataConfig: { dateFmt: "yyyy-MM-dd" }, containToday: true }).map((v, index) => {
          let time = v[0];
          return [
            this.$f.formatterDate(v[0], "MM.dd"),
            grid[time] || 0,
            zhongzhi[time] || 0,
            shichang[time] || 0,
            feijingqing[time] || 0
          ];
        })
      ];
    }
  },
  data() {
    return {
      legendConfig: {
        icon: "rect",
        itemWidth: 20,
        itemHeight: 6,
        top: 0,
        right: 250
      },
      items: [
        {
          // icon: "icon-biaoti",
          label: "12345热线",
          count: "-",
          key: "12345热线",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "110",
          count: "-",
          key: "110",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "119",
          count: "-",
          key: "119",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "120",
          count: "-",
          key: "120",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "962121",
          count: "-",
          key: "962121",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "网格巡查",
          count: "-",
          key: "网格",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "市场监管",
          count: "-",
          key: "市场监管",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "110非警情",
          count: "-",
          key: "110非警情",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "综治",
          count: "-",
          key: "综治",
          rate: "-",
          unit: "件"
        },
        {
          // icon: "icon-biaoti",
          label: "矛盾纠纷",
          count: "-",
          key: "矛盾纠纷",
          rate: "-",
          unit: "件"
        }
      ],
      chunkSize: 5,
      colors: ["#1ABC9C", "#679DF4", "#F96F4F", "#BE6CCC", "#D0021B"]
    };
  },

  methods: {
    handleClick(item) {
      console.log("item,", item);
      let component = "dashboard";
      if (["公共安全案件数", "公共管理案件数", "公共服务案件数"].indexOf(item.label) === -1) {
        component = "list";
      }
      this.$emit("click", component, item);
    }
  }
};
</script>

<style lang="scss" scoped>
.overview{
  width: 100%;
  height: 100%;

  .three-public{
    .wall{
      .block{
        height: 2.1rem;
      }
    }
    .chart{
      padding: 0.1rem 0;
      height: 4rem;
    }
  }
  .wall-panel{
    .tile-row{
      padding: 0.25rem 0;
    }
    .el-col, .m-column {
      border-right: 1px dashed #4E78A4;
      &:last-child{
        border: 0;
      }
    }
  }
}
</style>
